<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<script type="text/javascript" src="js/sjcl.js"></script>
<script type="text/javascript" src="js/private-note.js"></script>
<script>
	
	function f(frm) {

		// The id is the reference for the encrypted value on the server
		// but the server doesn't have the password to decrypt
		// The password is in the url given to someone and the decryption
		// happens in javascript so server never sees unencrypted values
		var id = document.getElementById('id');
		id.value = random_string(16);
		// generate password to encrypt with
		var password = random_string(16);
		var value = document.getElementById('value').value;
		var hidden = document.getElementById('encryptedValue');
		// encrypt the value using the password
		hidden.value = encrypt(password, value);

		const data = {};
		
		for (let input of frm) {
		  if (input.name && input.value) {
		    data[input.name] = input.value
		  }
		}
		
		var result = document.getElementById('result');
		result.innerHTML = "Sending...";
		
		fetch(frm.action, {
		  method: frm.method,
		  body: JSON.stringify(data)
		}).then(function(res) {
		  if (res.ok) {
		    console.log(res);
                    var u = window.location.origin + "/?id=" + id.value;
		    result.innerHTML = "<a href=" + u + ">" + u + "</a>";
		  } else {
		    console.log("error", res);
		    result.innerHTML = "Error, try again";
		  }
		});
		return false;
    }
	
	function getUrlVars() {
	    var vars = {};
	    var parts = window.location.href.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
	        vars[key] = value;
	    });
	    return vars;
	}
	
	function getUrlParam(parameter, defaultvalue){
	    var urlparameter = defaultvalue;
	    if(window.location.href.indexOf(parameter) > -1){
	        urlparameter = getUrlVars()[parameter];
	        }
	    return urlparameter;
	}
	
	function initialize() {
		var id = getUrlParam('id', '');
		if (id.length > 0) {
			document.getElementById('encrypt').style.display='none';
			document.getElementById('decrypt').style.display='block';
		} else {
			document.getElementById('encrypt').style.display='block';
			document.getElementById('decrypt').style.display='none';
		}
	    console.log("init run");
	}
	
	function view() {
		var d = document.getElementById('decrypted');
		fetch('get?id=' + getUrlParam('id', ''), {
			  method: 'GET'
			}).then(function(res) {
			  if (res.ok) {
			    console.log(res);
	            d.value = res.text;
			  } else {
			    console.log("error", res);
			    d.value = res.text;
			  }
			});
		d.style.display='block';
	}
	
	window.onload = initialize;
</script>
</head>
<body>
	<h3>Private Note</h3>
	<div id="encrypt">
		<form id="formEncrypt" onsubmit="return f(this)" method="POST"
			action="create">
			<textarea style="width: 90%; height: 75%" id="value"></textarea>
			<input type="hidden" id="encryptedValue" name="encryptedValue"></input><br />
			<input type="hidden" id="id" name="id"></input><br /> 
			<input
				type="submit" value="Encrypt"></input>
		</form>
		<p id="result"></p>
	</div>
	
	<div id="decrypt">
	    <button onclick="view()">View</button><br/>
	    <textarea id="decrypted" style="margin-top: 10px;width:90%; height:75%; display:none"></textarea>
	</div>
</body>
</html>
